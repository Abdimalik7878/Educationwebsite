<%- include("partials/nav_admin", { user }) %>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <div class="text-muted small">Page</div>
    <h1 class="h4 fw-bold mb-0"><%= page.title %></h1>
    <div class="text-muted small">Slug: <code><%= page.slug %></code> • Status: <b><%= page.status %></b></div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="/admin/pages/<%= page.id %>/edit">Edit Page</a>
    <a class="btn btn-dark" href="/admin">Back</a>
  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form class="row g-2 align-items-end" action="/admin/pages/<%= page.id %>/blocks/add" method="POST">
      <div class="col-md-4">
        <label class="form-label">Add block type</label>
        <select class="form-select" name="type">
          <option value="text">Text</option>
          <option value="image">Image</option>
          <option value="video">Video (YouTube or MP4)</option>
          <option value="callout">Callout (Key idea / Fun fact)</option>
          <option value="quiz">Quiz (MCQ)</option>
        </select>
      </div>
      <div class="col-md-3">
        <button class="btn btn-primary w-100">+ Add Block</button>
      </div>
      <div class="col-md-5 text-muted small">
        Tip: Use <b>Media</b> page to upload files. Copy the file URL into an Image/Video block.
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th style="width:70px;">#</th>
          <th style="width:160px;">Type</th>
          <th>Preview</th>
          <th style="width:280px;"></th>
        </tr>
      </thead>
      <tbody>
      <% if (!blocks || blocks.length===0) { %>
        <tr><td colspan="4" class="text-muted p-4">No blocks yet. Add one above.</td></tr>
      <% } %>

      <% blocks.forEach((b) => { %>
        <tr>
          <td class="fw-semibold"><%= b.position %></td>
          <td><span class="badge text-bg-light border"><%= b.type %></span></td>
          <td class="text-muted small">
            <% if (b.type==="text") { %>
              <b><%= b.data.heading || "(no heading)" %></b>
            <% } else if (b.type==="image") { %>
              <b><%= b.data.heading || "Image" %></b> — <%= b.data.imageUrl ? "URL set" : "no URL" %>
            <% } else if (b.type==="video") { %>
              <b><%= b.data.heading || "Video" %></b> — <%= b.data.mode %>
            <% } else if (b.type==="callout") { %>
              <b><%= b.data.kind || "Callout" %></b>
            <% } else if (b.type==="quiz") { %>
              <b><%= b.data.title || "Quiz" %></b> — <%= (b.data.questions||[]).length %> Qs
            <% } %>
          </td>
          <td class="text-end">
            <form action="/admin/blocks/<%= b.id %>/move" method="POST" style="display:inline;">
              <input type="hidden" name="dir" value="up"/>
              <button class="btn btn-sm btn-outline-secondary">↑</button>
            </form>
            <form action="/admin/blocks/<%= b.id %>/move" method="POST" style="display:inline;">
              <input type="hidden" name="dir" value="down"/>
              <button class="btn btn-sm btn-outline-secondary">↓</button>
            </form>
            <a class="btn btn-sm btn-outline-primary" href="/admin/blocks/<%= b.id %>/edit">Edit</a>
            <form action="/admin/blocks/<%= b.id %>/delete" method="POST" style="display:inline;" onsubmit="return confirm('Delete this block?');">
              <button class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
          </td>
        </tr>
      <% }) %>
      </tbody>
    </table>
  </div>
</div>

<div class="mt-3">
  <% if (page.status === "published") { %>
    <a class="btn btn-success" href="/p/<%= page.slug %>">View published page</a>
  <% } else { %>
    <div class="text-muted small">This page is draft. Change status to <b>published</b> to view on public site.</div>
  <% } %>
</div>

<%- include("partials/footer_admin") %>
